name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Cache Library folder
        uses: actions/cache@v4
        with:
          path: My project/Library
          key: Library-Android-${{ hashFiles('My project/Assets/**', 'My project/Packages/**', 'My project/ProjectSettings/**') }}
          restore-keys: |
            Library-Android-
            Library-
      
      - name: Build Unity Project
        shell: powershell
        run: |
          $unityPath = Get-ChildItem "C:\Program Files\Unity\Hub\Editor" -Directory | 
            Sort-Object Name -Descending | 
            Select-Object -First 1 | 
            ForEach-Object { Join-Path $_.FullName "Editor\Unity.exe" }
          
          if (-not (Test-Path $unityPath)) {
            Write-Error "Unity not found. Please install Unity Hub and Unity 2021 LTS with Android Build Support"
            exit 1
          }
          
          Write-Host "Using Unity at: $unityPath"
          
          & $unityPath -quit -batchmode -nographics `
            -projectPath "${{ github.workspace }}/My project" `
            -buildTarget Android `
            -executeMethod BuildScript.BuildAndroidAPK `
            -logFile "${{ github.workspace }}/build.log"
          
          if ($LASTEXITCODE -ne 0) {
            Get-Content "${{ github.workspace }}/build.log" -Tail 50
            exit $LASTEXITCODE
          }
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ClubBlackout-Android
          path: My project/Builds/Android/*.apk
          retention-days: 30
