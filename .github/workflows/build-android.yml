name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Cache Library folder
        uses: actions/cache@v4
        with:
          path: My project/Library
          key: Library-Android-${{ hashFiles('My project/Assets/**', 'My project/Packages/**', 'My project/ProjectSettings/**') }}
          restore-keys: |
            Library-Android-
            Library-
      
      - name: Build Unity Project
        shell: powershell
        run: |
          $unityPath = Get-ChildItem "C:\Program Files\Unity\Hub\Editor" -Directory | 
            Sort-Object Name -Descending | 
            Select-Object -First 1 | 
            ForEach-Object { Join-Path $_.FullName "Editor\Unity.exe" }
          
          if (-not (Test-Path $unityPath)) {
            Write-Error "Unity not found. Please install Unity Hub and Unity 2021 LTS with Android Build Support"
            exit 1
          }
          
          Write-Host "Using Unity at: $unityPath"
          
          # Change to workspace directory
          Set-Location "${{ github.workspace }}"
          
          $projectPath = (Resolve-Path "My project").Path
          $logPath = "build.log"
          
          Write-Host "Project path: $projectPath"
          
          # First, generate scenes
          Write-Host "Generating Unity scenes..."
          & $unityPath -quit -batchmode -nographics `
            -projectPath "`"$projectPath`"" `
            -executeMethod SceneSetupTool.SetupAllScenes `
            -logFile $logPath
          
          Start-Sleep -Seconds 5
          
          # Then build Android APK
          Write-Host "Building Android APK..."
          & $unityPath -quit -batchmode -nographics `
            -projectPath "`"$projectPath`"" `
            -buildTarget Android `
            -executeMethod BuildScript.BuildAndroidAPK `
            -logFile $logPath
          
          $exitCode = $LASTEXITCODE
          
          if (Test-Path $logPath) {
            Write-Host "Build log:"
            Get-Content $logPath -Tail 100
          }
          
          # Check if APK was created
          $apkPath = "My project\Builds\Android\ClubBlackout.apk"
          if (Test-Path $apkPath) {
            Write-Host "APK created successfully at: $apkPath"
          } else {
            Write-Error "APK was not created at expected path: $apkPath"
            exit 1
          }
          
          if ($exitCode -ne 0) {
            exit $exitCode
          }
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ClubBlackout-Android
          path: My project/Builds/Android/ClubBlackout.apk
          retention-days: 30
